<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>SysEx Controller</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      color: #444;
    }

    .control-group {
      margin-bottom: 20px;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 8px;
    }

    label {
      display: block;
      margin-top: 10px;
    }

    input,
    select,
    button {
      margin-top: 5px;
    }

    button {
      padding: 10px;
      background-color: #0078D7;
      color: white;
      border: none;
      cursor: pointer;
    }

    button:hover {
      background-color: #005EA2;
    }
  </style>
</head>

<body>
  <h1>SysEx MIDI Controller</h1>

  <script>
    var hexCompleto = "F0 44 00 00 70 20 60 06 00 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 01 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 07 00 07 07 0F 0F 0C 0B 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 0B 00 00 07 00 0F 07 0F 0F 04 0C 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 0C 00 00 07 00 00 04 00 08 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 0C 00 00 00 0A 00 00 02 00 01 01 00 00 00 00 01 00 07 07 0F 07 0E 0B 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 01 00 0F 07 0A 06 05 0C 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 01 00 0F 07 0E 03 01 0E 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 F7";
    var hexTest = "00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 00 00 02 00 00 00 00 01 00 00 00 00 00 00 02 00 00 00 00 00 00 00 00 07 00 07 07 0F 0F 0C 0B 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 0B 00 00 07 00 0F 07 0F 0F 04 0C 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 0C 00 00 07 00 00 04 00 08 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 0C 00 00 00 0A 00 00 02 00 01 01 00 00 00 00 01 00 07 07 0F 07 0E 0B 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 0C 03 00 00 01 00 0F 07 0A 06 05 0C 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 04 04 00 00 01 00 0F 07 0E 03 01 0E 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 00 04 00 00 F7";
    var sysexHeader = "F0 44 00 00 70 20"; // syex initial, last 20 is program change request
    var sysexProgram = "60";  // 60 current working memory

    // all values are returned as "half bytes", so instead of sending 5F we send 0F 05
    function splitHexValue(hexValue) {
      // Ensure input is in correct format
      const cleanHex = hexValue.toString().toUpperCase().replace(/[^0-9A-F]/g, '');
      if (cleanHex.length !== 2) throw new Error('Input must be a 2-digit hex value');

      const firstChar = cleanHex[0];
      const secondChar = cleanHex[1];

      return `0${secondChar} 0${firstChar}`;
    }

    function getOctaveAndLineSelect(octave, lineSelect) {
      // Validate octave input
      if (![0, 1, -1].includes(octave)) {
        throw new Error("Octave must be 0, +1, or -1");
      }

      // Validate line select input
      const validLineSelects = [1, 2, 11, 12];
      if (!validLineSelects.includes(lineSelect)) {
        throw new Error("Line select must be 1, 2, 11, or 12");
      }

      // First 4 bits are always 0000
      let binaryResult = '0000';

      // Add octave bits
      switch (octave) {
        case 0:
          binaryResult += '00';
          break;
        case 1:
          binaryResult += '01';
          break;
        case -1:
          binaryResult += '10';
          break;
      }

      // Add line select bits
      switch (lineSelect) {
        case 1:
          binaryResult += '00';
          break;
        case 2:
          binaryResult += '01';
          break;
        case 11:
          binaryResult += '10';
          break;
        case 12:
          binaryResult += '11';
          break;
      }

      // Convert binary to hex
      const decimal = parseInt(binaryResult, 2);
      const hex = decimal.toString(16).padStart(2, '0').toUpperCase();

      return splitHexValue(hex);

    }

    function concat(...args) {
      return args.join(' ');
    }
    var getSysex = function () {
      var octaveAndLine = getOctaveAndLineSelect(0, 2);
      return concat(sysexHeader, sysexProgram,octaveAndLine, hexTest);
    }


    async function sendSysEx(hexString) {
      try {
        // Convert hex string to Uint8Array
        const cleanHex = hexString.replace(/\s+/g, '');
        if (!/^[0-9A-Fa-f]+$/.test(cleanHex)) {
          throw new Error('Invalid hex string');
        }

        const sysexData = new Uint8Array(
          cleanHex.match(/.{1,2}/g).map(byte => parseInt(byte, 16))
        );

        const midiAccess = await navigator.requestMIDIAccess({ sysex: true });
        const outputs = midiAccess.outputs.values();
        var firstOutput = outputs.next().value;
        firstOutput = outputs.next().value;

        if (!firstOutput) {
          throw new Error('No MIDI output found');
        }

        firstOutput.send(sysexData);
        return true;
      } catch (error) {
        console.error('SysEx send error:', error);
        return false;
      }
    }

    sendSysEx(getSysex());

  </script>
</body>

</html>